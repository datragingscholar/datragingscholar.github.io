<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.5 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="UT" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>FreeBSD Rootkit Design Howtos - 6 - Character Device First cdev Application | Raging Scholar</title>
<meta name="description" content="This is a refined version using uiomove() instead of copystr(). It surprisedme when I found out how easy it was to use uiomove() function. Anyway, I madethe change, along with some debug messages to make the result more descriptive,so let’s take a look at the refined code and compile it first.">



<meta property="og:type" content="article">
<meta property="og:locale" content="UTF_8">
<meta property="og:site_name" content="Raging Scholar">
<meta property="og:title" content="FreeBSD Rootkit Design Howtos - 6 - Character Device First cdev Application">
<meta property="og:url" content="http://localhost:4000/freebsd-rootkit-design-howtos-6-character-device-first-cdev-application/">


  <meta property="og:description" content="This is a refined version using uiomove() instead of copystr(). It surprisedme when I found out how easy it was to use uiomove() function. Anyway, I madethe change, along with some debug messages to make the result more descriptive,so let’s take a look at the refined code and compile it first.">







  <meta property="article:published_time" content="2011-04-13T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:4000/freebsd-rootkit-design-howtos-6-character-device-first-cdev-application/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Hai Lang",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Raging Scholar Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Raging Scholar
          <span class="site-subtitle">uprintf("There is no place like ::1");</span>
        </a>
        <ul class="visible-links"></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">FreeBSD Rootkit Design Howtos - 6 - Character Device First cdev Application</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/bio-photo.jpg" alt="Hai Lang" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Hai Lang</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>An OCD Source Code Hygienist who has way too many hobbies, and way too keen to share his ideas.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Xi'an, China</span>
        </li>
      

      
        
          
        
          
        
          
        
          
        
          
        
          
        
      

      

      
        <li>
          <a href="mailto:ragingscholar@protonmail.com">
            <meta itemprop="email" content="ragingscholar@protonmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="FreeBSD Rootkit Design Howtos - 6 - Character Device First cdev Application">
    <meta itemprop="description" content="This is a refined version using uiomove() instead of copystr(). It surprisedme when I found out how easy it was to use uiomove() function. Anyway, I madethe change, along with some debug messages to make the result more descriptive,so let’s take a look at the refined code and compile it first.">
    <meta itemprop="datePublished" content="April 13, 2011">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">FreeBSD Rootkit Design Howtos - 6 - Character Device First cdev Application
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>This is a refined version using <code class="highlighter-rouge">uiomove()</code> instead of <code class="highlighter-rouge">copystr()</code>. It surprised
me when I found out how easy it was to use <code class="highlighter-rouge">uiomove()</code> function. Anyway, I made
the change, along with some debug messages to make the result more descriptive,
so let’s take a look at the refined code and compile it first.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/param.h&gt;
#include &lt;sys/proc.h&gt;
#include &lt;sys/module.h&gt;
#include &lt;sys/kernel.h&gt;
#include &lt;sys/systm.h&gt;
#include &lt;sys/conf.h&gt;
#include &lt;sys/uio.h&gt;
</span>
<span class="c1">// Function prototypes
</span><span class="n">d_open_t</span> <span class="n">open</span><span class="p">;</span>
<span class="n">d_close_t</span> <span class="n">close</span><span class="p">;</span>
<span class="n">d_read_t</span> <span class="n">read</span><span class="p">;</span>
<span class="n">d_write_t</span> <span class="n">write</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cdevsw</span> <span class="n">cd_example_cdevsw</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">d_version</span> <span class="o">=</span> <span class="n">D_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">d_open</span> <span class="o">=</span> <span class="n">open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">d_close</span> <span class="o">=</span> <span class="n">close</span><span class="p">,</span>
    <span class="p">.</span><span class="n">d_read</span> <span class="o">=</span> <span class="n">read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">d_write</span> <span class="o">=</span> <span class="n">write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">d_name</span> <span class="o">=</span><span class="s">"cd_example"</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//A string in kernel space
</span><span class="k">static</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">otyp</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Initialize character buffer. */</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'�'</span><span class="p">,</span> <span class="mi">513</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[cd_example]Open Called!n"</span><span class="p">);</span>

    <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">close</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">otyp</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[cd_example]Close Called!n"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uio</span> <span class="o">*</span><span class="n">uio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioflag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">error</span> <span class="o">=</span> <span class="n">copyinstr</span><span class="p">(</span><span class="n">uio</span><span class="o">-&gt;</span><span class="n">uio_iov</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[cd_example]Write to "</span><span class="n">cd_example</span><span class="s">" failed.n"</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[cd_example]Write Called! String is:%sn"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">read</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uio</span> <span class="o">*</span><span class="n">uio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioflag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[cd_example]Read Called! ERROR: Length is invalid!n"</span><span class="p">);</span>
        <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* Return the saved character string to userland. */</span>
    <span class="n">uiomove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">513</span><span class="p">,</span> <span class="n">uio</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[cd_example]Read Called! String is:%sn"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reference to the device in DEVFS */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load</span><span class="p">(</span><span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">MOD_LOAD</span><span class="p">:</span>
            <span class="n">sdev</span> <span class="o">=</span> <span class="n">make_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cd_example_cdevsw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">UID_ROOT</span><span class="p">,</span> <span class="n">GID_WHEEL</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="s">"cd_example"</span><span class="p">);</span>
            <span class="n">uprintf</span><span class="p">(</span><span class="s">"Character device loaded.n"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">MOD_UNLOAD</span><span class="p">:</span>
            <span class="n">destroy_dev</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
            <span class="n">uprintf</span><span class="p">(</span><span class="s">"Character device unloaded.n"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="nl">default:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">EOPNOTSUPP</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">DEV_MODULE</span><span class="p">(</span><span class="n">cd_example</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Nothing much changed except <code class="highlighter-rouge">uiomove(&amp;buf, 513, uio)</code>; part.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ZFSTest</span><span class="err">#</span> <span class="n">make</span>
<span class="n">Warning</span><span class="o">:</span> <span class="n">Object</span> <span class="n">directory</span> <span class="n">not</span> <span class="n">changed</span> <span class="n">from</span> <span class="n">original</span> <span class="o">/</span><span class="n">zroot</span><span class="o">/</span><span class="n">development</span><span class="o">/</span><span class="mf">3.</span><span class="n">Character_device</span>
<span class="n">cc</span> <span class="o">-</span><span class="n">O2</span> <span class="o">-</span><span class="n">pipe</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">strict</span><span class="o">-</span><span class="n">aliasing</span> <span class="o">-</span><span class="n">Werror</span> <span class="o">-</span><span class="n">D_KERNEL</span> <span class="o">-</span><span class="n">DKLD_MODULE</span> <span class="o">-</span><span class="n">nostdinc</span>   <span class="o">-</span><span class="n">I</span><span class="p">.</span> <span class="o">-</span><span class="n">I</span><span class="err">@</span> <span class="o">-</span><span class="n">I</span><span class="err">@</span><span class="o">/</span><span class="n">contrib</span><span class="o">/</span><span class="n">altq</span> <span class="o">-</span><span class="n">finline</span><span class="o">-</span><span class="n">limit</span><span class="o">=</span><span class="mi">8000</span> <span class="o">--</span><span class="n">param</span> <span class="kr">inline</span><span class="o">-</span><span class="n">unit</span><span class="o">-</span><span class="n">growth</span><span class="o">=</span><span class="mi">100</span> <span class="o">--</span><span class="n">param</span> <span class="n">large</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">growth</span><span class="o">=</span><span class="mi">1000</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">common</span>  <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">omit</span><span class="o">-</span><span class="n">frame</span><span class="o">-</span><span class="n">pointer</span>  <span class="o">-</span><span class="n">mcmodel</span><span class="o">=</span><span class="n">kernel</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">red</span><span class="o">-</span><span class="n">zone</span>  <span class="o">-</span><span class="n">mfpmath</span><span class="o">=</span><span class="mi">387</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">sse</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">sse2</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">sse3</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">mmx</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="mi">3</span><span class="n">dnow</span>  <span class="o">-</span><span class="n">msoft</span><span class="o">-</span><span class="kt">float</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">asynchronous</span><span class="o">-</span><span class="n">unwind</span><span class="o">-</span><span class="n">tables</span> <span class="o">-</span><span class="n">ffreestanding</span> <span class="o">-</span><span class="n">fstack</span><span class="o">-</span><span class="n">protector</span> <span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">iso9899</span><span class="o">:</span><span class="mi">1999</span> <span class="o">-</span><span class="n">fstack</span><span class="o">-</span><span class="n">protector</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">Wredundant</span><span class="o">-</span><span class="n">decls</span> <span class="o">-</span><span class="n">Wnested</span><span class="o">-</span><span class="n">externs</span> <span class="o">-</span><span class="n">Wstrict</span><span class="o">-</span><span class="n">prototypes</span>  <span class="o">-</span><span class="n">Wmissing</span><span class="o">-</span><span class="n">prototypes</span> <span class="o">-</span><span class="n">Wpointer</span><span class="o">-</span><span class="n">arith</span> <span class="o">-</span><span class="n">Winline</span> <span class="o">-</span><span class="n">Wcast</span><span class="o">-</span><span class="n">qual</span>  <span class="o">-</span><span class="n">Wundef</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">pointer</span><span class="o">-</span><span class="n">sign</span> <span class="o">-</span><span class="n">fformat</span><span class="o">-</span><span class="n">extensions</span> <span class="o">-</span><span class="n">c</span> <span class="n">cdev</span><span class="p">.</span><span class="n">c</span>
<span class="n">ld</span>  <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">warn</span><span class="o">-</span><span class="n">common</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">o</span> <span class="n">cd_example</span><span class="p">.</span><span class="n">ko</span> <span class="n">cdev</span><span class="p">.</span><span class="n">o</span>
<span class="o">:&gt;</span> <span class="n">export_syms</span>
<span class="n">awk</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">kmod_syms</span><span class="p">.</span><span class="n">awk</span> <span class="n">cd_example</span><span class="p">.</span><span class="n">ko</span>  <span class="n">export_syms</span> <span class="o">|</span> <span class="n">xargs</span> <span class="o">-</span><span class="n">J</span><span class="o">%</span> <span class="n">objcopy</span> <span class="o">%</span> <span class="n">cd_example</span><span class="p">.</span><span class="n">ko</span>
<span class="n">objcopy</span> <span class="o">--</span><span class="n">strip</span><span class="o">-</span><span class="n">debug</span> <span class="n">cd_example</span><span class="p">.</span><span class="n">ko</span>
<span class="n">ZFSTest</span><span class="err">#</span> <span class="n">kldload</span> <span class="p">.</span><span class="o">/</span><span class="n">cd_example</span><span class="p">.</span><span class="n">ko</span>
<span class="n">Character</span> <span class="n">device</span> <span class="n">loaded</span><span class="p">.</span>
</code></pre></div></div>

<h2 id="the-application">The Application</h2>

<p>Same as the relationship between system call and its application, you can
consider this as C/S model, one service, one client. There’s nothing tricky in
this client application code, except that we used a file descriptor to open our
device interface under DEVFS, and <code class="highlighter-rouge">write()</code>, <code class="highlighter-rouge">read()</code>, <code class="highlighter-rouge">open()</code>, <code class="highlighter-rouge">close()</code>
functions to interact with it.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt; //Add this to avoid warning
#include &lt;fcntl.h&gt;
#include &lt;paths.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
</span>
<span class="cp">#define CDEV_DEVICE "cd_example"
</span><span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Usage:n%s &lt;string&gt;n"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">kernel_fd</span><span class="p">;</span> <span class="c1">//Kernel File Descriptor
</span>    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

    <span class="cm">/* Open cd_example. */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">kernel_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/"</span> <span class="n">CDEV_DEVICE</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"/dev/"</span> <span class="n">CDEV_DEVICE</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: String too longn"</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Write to cd_example. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">kernel_fd</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"write()"</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Wrote "</span><span class="o">%</span><span class="n">s</span><span class="s">" to device /dev/"</span> <span class="n">CDEV_DEVICE</span> <span class="s">".n"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="cm">/* Read from cd_example. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">kernel_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"read()"</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Read "</span><span class="o">%</span><span class="n">s</span><span class="s">" from device /dev/"</span> <span class="n">CDEV_DEVICE</span> <span class="s">".n"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="cm">/* Close cd_example. */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">close</span><span class="p">(</span><span class="n">kernel_fd</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"close()"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ZFSTest# gcc <span class="nt">-o</span> testcdev testcdev.c
ZFSTest# ./testcdev Having fun with cdev
Wrote <span class="s2">"Having fun with cdev"</span> to device /dev/cd_example.
Read <span class="s2">"Having fun with cdev"</span> from device /dev/cd_example.
ZFSTest# dmesg | tail <span class="nt">-n</span> 5
<span class="nt">---</span> syscall <span class="o">(</span>5, FreeBSD ELF64, open<span class="o">)</span>, rip <span class="o">=</span> 0x800732abc, rsp <span class="o">=</span> 0x7ffffffbc058, rbp <span class="o">=</span> 0x7ffffffe6089 <span class="nt">---</span>
<span class="o">[</span>cd_example]Open Called!
<span class="o">[</span>cd_example]Write Called! String is:Having fun with cdev
<span class="o">[</span>cd_example]Read Called! String is:Having fun with cdev
<span class="o">[</span>cd_example]Close Called!
ZFSTest#
</code></pre></div></div>

<p>Pretty straightforward code, so let’s keep this note simple. Let’s jump right
into the next note, see you there!</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#c" class="page__taxonomy-item" rel="tag">C++</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#freebsd" class="page__taxonomy-item" rel="tag">FreeBSD</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#rootkit" class="page__taxonomy-item" rel="tag">Rootkit</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2011-04-13T00:00:00+08:00">April 13, 2011</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=FreeBSD+Rootkit+Design+Howtos+-+6+-+Character+Device+First+cdev+Application%20http%3A%2F%2Flocalhost%3A4000%2Ffreebsd-rootkit-design-howtos-6-character-device-first-cdev-application%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Ffreebsd-rootkit-design-howtos-6-character-device-first-cdev-application%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Ffreebsd-rootkit-design-howtos-6-character-device-first-cdev-application%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/freebsd-rootkit-design-howtos-5-character-device-first-cdev-module/" class="pagination--pager" title="FreeBSD Rootkit Design Howtos - 5 - Character Device First cdev Module
">Previous</a>
    
    
      <a href="/freebsd-rootkit-design-howtos-7-linker-files-and-chapter-summary/" class="pagination--pager" title="FreeBSD Rootkit Design Howtos - 7 - Linker Files and Chapter Summary
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/what-is-wrong-with-microservice/" rel="permalink">What is wrong with microservice
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Welcome

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/clean-code-tips-and-tricks-general-guidelines-and-solid-principle/" rel="permalink">Clean Code Tips and Tricks: General Guidelines and S.O.L.I.D Principle
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  24 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Welcome back fellow computer witches and wizards, let’s get back to where we
left on Clean Code Tips and Tricks. This will the be the last instalment, we’ll
...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/clean-code-tips-and-tricks-method-names-and-single-responsibility-principle/" rel="permalink">Clean Code Tips and Tricks: Method Names and Single Responsibility Principle
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Hello fellow geeks, welcome back to the second instalment of Clean Code Tips and
Tricks. As said at the end of the first one, we are going to
talk about meth...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/clean-code-tips-and-tricks-introduction-variables/" rel="permalink">Clean Code Tips and Tricks: Introduction &amp; Variables
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  11 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">I recently organized a workshop for my team members to talk about Clean Code. It
has been a major issue plaguing the team and has been slowing us down by
gen...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Hai Lang. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
